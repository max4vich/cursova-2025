## Order lifecycle

1. **Cart & checkout facade**
   - Користувач наповнює кошик (`cartService`) й натискає «Оформити».
   - `CheckoutFacade` агрегує кошик, застосовує промокод (`promotionService`) і рахує draft заказу (subtotal, discount, shipping, tax, total), а також викликає макетні інтеграції оплати/доставки.

2. **Atomic Prisma transaction (`orderService.checkout`)**
   - Весь запис замовлення, оновлення залишків та очистка кошика виконується в одному `prisma.$transaction(..., { timeout: 15000 })`.
   - Перед створенням замовлення `ensureProductAvailability` перевіряє залишки кожного товару й атомарно зменшує `product.stock`. Якщо запасу не вистачає — транзакція скасовується з помилкою “Недостатньо залишку…”.
   - `order.create` створює замовлення, позиції, платіж і відправку. Якщо промокод був активний — лічильник використань інкрементується в тій же транзакції (`promotionService.incrementUsage` отримує `tx`).
   - Кошик користувача очищається, а прив'язаний промокод скидається.

3. **Після транзакції**
   - API повертає створене замовлення; фронтенд може показати підтвердження.
   - У профілі користувача (`/profile`) замовлення беруться напряму з `orderService.listOrders`.

> Таким чином залишки, промокоди та кошик завжди синхронізовані: або операція проходить цілком, або не відбувається нічого.

